name: Validate

on:
  pull_request:
  push:
    branches: [main]

jobs:
  bash-syntax:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate shell syntax
        run: |
          set -Eeuo pipefail
          mapfile -t files < <(git ls-files '*.sh')
          if [[ "${#files[@]}" -eq 0 ]]; then
            echo "No shell files found"
            exit 0
          fi
          bash -n "${files[@]}"

  dry-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run dry-run commands
        run: |
          set -Eeuo pipefail
          chmod +x run.sh host/run-host.sh scripts/bootstrap/*.sh
          ./host/run-host.sh --dry-run
          ./run.sh --dry-run
          make install DRY_RUN=true
          make teardown DRY_RUN=true
          make platform-certs-staging DRY_RUN=true
          make platform-certs-prod DRY_RUN=true
          make app-test-staging-le-staging DRY_RUN=true
          make app-test-staging-le-prod DRY_RUN=true
          make app-test-prod-le-staging DRY_RUN=true
          make app-test-prod-le-prod DRY_RUN=true
          make help

  kustomize-structure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Validate kustomize render paths
        run: |
          set -Eeuo pipefail
          kubectl kustomize clusters/home/flux-system >/dev/null
          kubectl kustomize clusters/home/flux-system/sources >/dev/null
          kubectl kustomize clusters/home >/dev/null
          kubectl kustomize infrastructure/overlays/home >/dev/null
          kubectl kustomize infrastructure/namespaces >/dev/null
          kubectl kustomize infrastructure/cert-manager/base >/dev/null
          kubectl kustomize infrastructure/cert-manager/issuers >/dev/null
          kubectl kustomize infrastructure/cilium/base >/dev/null
          kubectl kustomize infrastructure/metrics-server/base >/dev/null
          kubectl kustomize infrastructure/ingress-nginx/base >/dev/null
          kubectl kustomize infrastructure/ingress-traefik/base >/dev/null
          kubectl kustomize infrastructure/storage/minio/base >/dev/null
          kubectl kustomize infrastructure/storage/ceph/base >/dev/null
          kubectl kustomize platform-services/overlays/home >/dev/null
          kubectl kustomize platform-services/runtime-inputs >/dev/null
          kubectl kustomize platform-services/oauth2-proxy/base >/dev/null
          kubectl kustomize platform-services/clickstack/base >/dev/null
          kubectl kustomize platform-services/otel/base >/dev/null
          kubectl kustomize tenants >/dev/null
          kubectl kustomize tenants/app-envs >/dev/null
          kubectl kustomize tenants/apps/example/base >/dev/null
          kubectl kustomize tenants/apps/example/overlays/staging >/dev/null
          kubectl kustomize tenants/apps/example/overlays/staging-url-prod >/dev/null
          kubectl kustomize tenants/apps/example/overlays/prod >/dev/null
          kubectl kustomize tenants/apps/example/overlays/prod-url-staging >/dev/null
          kubectl kustomize tenants/overlays/app-staging-le-staging >/dev/null
          kubectl kustomize tenants/overlays/app-staging-le-prod >/dev/null
          kubectl kustomize tenants/overlays/app-prod-le-staging >/dev/null
          kubectl kustomize tenants/overlays/app-prod-le-prod >/dev/null
