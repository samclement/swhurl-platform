name: Validate

on:
  pull_request:
  push:
    branches: [main]

jobs:
  bash-syntax:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate shell syntax
        run: |
          set -Eeuo pipefail
          mapfile -t files < <(git ls-files '*.sh')
          if [[ "${#files[@]}" -eq 0 ]]; then
            echo "No shell files found"
            exit 0
          fi
          bash -n "${files[@]}"

  dry-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run dry-run commands
        run: |
          set -Eeuo pipefail
          chmod +x run.sh host/run-host.sh scripts/compat/*.sh scripts/bootstrap/*.sh scripts/manual_install_k3s_minimal.sh scripts/manual_configure_route53_dns_updater.sh
          ./host/run-host.sh --dry-run
          ./scripts/manual_install_k3s_minimal.sh --dry-run
          ./scripts/manual_configure_route53_dns_updater.sh --dry-run
          ./run.sh --dry-run
          ./run.sh --dry-run --profile profiles/overlay-staging.env
          ./run.sh --dry-run --profile profiles/overlay-prod.env
          ./run.sh --dry-run --profile profiles/provider-traefik.env
          ./run.sh --dry-run --profile profiles/provider-ceph.env
          ./run.sh --dry-run --profile profiles/provider-traefik-ceph.env
          ./run.sh --dry-run --profile profiles/test-loop.env
          ./run.sh --dry-run --profile profiles/test-loop-selfsigned.env
          ./run.sh --dry-run --with-host
          ./run.sh --dry-run --with-host --delete
          ./scripts/compat/run-legacy-pipeline.sh --dry-run
          ./scripts/compat/repeat-scratch-cycles.sh --help
          make help

  kustomize-structure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Validate kustomize render paths
        run: |
          set -Eeuo pipefail
          kubectl kustomize cluster/flux >/dev/null
          kubectl kustomize cluster/overlays/homelab/flux >/dev/null
          kubectl kustomize cluster/overlays/homelab >/dev/null
          kubectl kustomize cluster/overlays/homelab/providers/ingress-traefik >/dev/null
          kubectl kustomize cluster/overlays/homelab/providers/ingress-nginx >/dev/null
          kubectl kustomize cluster/overlays/homelab/providers/storage-minio >/dev/null
          kubectl kustomize cluster/overlays/homelab/providers/storage-ceph >/dev/null
          kubectl kustomize cluster/overlays/homelab/apps/staging >/dev/null
          kubectl kustomize cluster/overlays/homelab/apps/prod >/dev/null
          kubectl kustomize cluster/base/namespaces >/dev/null
          kubectl kustomize cluster/base/cert-manager >/dev/null
          kubectl kustomize cluster/base/cert-manager/issuers >/dev/null
          kubectl kustomize cluster/base/cilium >/dev/null
          kubectl kustomize cluster/base/oauth2-proxy >/dev/null
          kubectl kustomize cluster/base/clickstack >/dev/null
          kubectl kustomize cluster/base/otel >/dev/null
          kubectl kustomize cluster/base/storage >/dev/null
          kubectl kustomize cluster/base/storage/minio >/dev/null
          kubectl kustomize cluster/base/storage/ceph >/dev/null
          kubectl kustomize cluster/base/apps/example >/dev/null

  provider-matrix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Setup Helmfile
        run: |
          set -Eeuo pipefail
          HELMFILE_VERSION=v0.168.0
          curl -fsSL -o /tmp/helmfile.tar.gz "https://github.com/helmfile/helmfile/releases/download/${HELMFILE_VERSION}/helmfile_${HELMFILE_VERSION#v}_linux_amd64.tar.gz"
          tar -xzf /tmp/helmfile.tar.gz -C /tmp
          sudo mv /tmp/helmfile /usr/local/bin/helmfile
          helmfile --version

      - name: Verify provider matrix
        run: |
          set -Eeuo pipefail
          ./scripts/97_verify_provider_matrix.sh
