name: Validate

on:
  pull_request:
  push:
    branches: [main]

jobs:
  bash-syntax:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate shell syntax
        run: |
          set -Eeuo pipefail
          mapfile -t files < <(git ls-files '*.sh')
          if [[ "${#files[@]}" -eq 0 ]]; then
            echo "No shell files found"
            exit 0
          fi
          bash -n "${files[@]}"

  dry-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run dry-run commands
        run: |
          set -Eeuo pipefail
          chmod +x run.sh host/run-host.sh scripts/compat/*.sh scripts/bootstrap/*.sh scripts/manual_install_k3s_minimal.sh scripts/manual_configure_route53_dns_updater.sh
          ./host/run-host.sh --dry-run
          ./scripts/manual_install_k3s_minimal.sh --dry-run
          ./scripts/manual_configure_route53_dns_updater.sh --dry-run
          ./run.sh --dry-run
          ./run.sh --dry-run --with-host
          ./run.sh --dry-run --with-host --delete
          ./scripts/compat/run-legacy-pipeline.sh --dry-run
          make help

  kustomize-structure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Validate kustomize render paths
        run: |
          set -Eeuo pipefail
          kubectl kustomize cluster/flux >/dev/null
          kubectl kustomize cluster/overlays/homelab/flux >/dev/null
          kubectl kustomize cluster/overlays/homelab >/dev/null
          kubectl kustomize cluster/overlays/homelab/providers/ingress-traefik >/dev/null
          kubectl kustomize cluster/overlays/homelab/providers/ingress-nginx >/dev/null
          kubectl kustomize cluster/overlays/homelab/providers/storage-minio >/dev/null
          kubectl kustomize cluster/overlays/homelab/providers/storage-ceph >/dev/null
          kubectl kustomize cluster/base/namespaces >/dev/null
